trigger:
  branches:
    include:
    - main
variables:
- name: imageName
  value: 'demo-app'
- name: acrRegistry
  value: 'argocd211.azurecr.io'
pool:
  name: 'sashcell'
  demands:
  - Agent.OS -equals Darwin
  - Agent.OSArchitecture -equals ARM64
stages:
- stage: BuildAndPush
  displayName: "CI — Build & Push Image"
  jobs:
  - job: BuildJob
    displayName: "Build & Push Image to ACR"
    steps:
    - task: 6d15af64-176c-496d-b583-fd2ae21d4df4@1
      inputs:
        repository: self
    - task: CmdLine@2
      displayName: "Verify Agent & Docker Architecture"
      inputs:
        script: |
          echo "Agent architecture:"
          uname -m
          docker version
    - task: Docker@2
      displayName: "Build & Push Docker Image (ARM64)"
      inputs:
        containerRegistry: argocd-acr
        repository: $(imageName)
        command: buildAndPush
        Dockerfile: Dockerfile
        buildContext: .
        tags: |
          $(Build.BuildId)
          latest
        arguments: --platform=linux/arm64
    - task: Bash@3
      name: SetImageTag
      displayName: "Set Image Tag Output"
      inputs:
        targetType: inline
        script: |
          echo "##vso[task.setvariable variable=imageTag;isOutput=true]$(Build.BuildId)"
- stage: UpdateGitOps
  displayName: "CD — Update GitOps Repo"
  dependsOn:
  - BuildAndPush
  condition: succeeded()
  variables:
  - name: imageTag
    value: $[ stageDependencies.BuildAndPush.BuildJob.outputs['SetImageTag.imageTag'] ]
  jobs:
  - job: UpdateGitOpsJob
    displayName: "Commit Updated Image Tag to GitOps Repo"
    steps:
    - task: 6d15af64-176c-496d-b583-fd2ae21d4df4@1
      condition: false
      inputs:
        repository: none
    - task: Bash@3
      displayName: "Clone & Update GitOps Repo"
      env:
        GITOPS_PAT_SECRET: $(GITOPS_PAT)
      inputs:
        targetType: inline
        script: |
          set -e

          export GIT_CLONE_DIR="gitops-local"
          export K8S_DEPLOYMENT_PATH="gitops-repo/k8s/deployment.yaml"

          git config --global user.email "pipeline@devops.com"
          git config --global user.name "Azure DevOps Pipeline"

          GIT_URL="https://x:${GITOPS_PAT_SECRET}@dev.azure.com/sashcell/Demo-App/_git/Demo-App"
          git clone $GIT_URL $GIT_CLONE_DIR
          cd $GIT_CLONE_DIR
          git checkout main

          FULL_IMAGE="$(acrRegistry)/$(imageName):$(imageTag)"
          sed -i "" "s|image: .*|image: ${FULL_IMAGE}|" $K8S_DEPLOYMENT_PATH  # macOS sed requires "" for inline edit

          git add $K8S_DEPLOYMENT_PATH
          git commit -m "Update image to ${FULL_IMAGE} via Azure Pipeline"
          git push origin main
